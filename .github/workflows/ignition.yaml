name: Acceptance Tests (Ignition 8.3)

on:
  workflow_call:
  workflow_dispatch:

jobs:
  acceptance:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    env:
      IGNITION_HOST: "http://localhost:8088"
      IGNITION_TOKEN: "terraform:bNxwTt2cyiFUwWFliYY6Fc5flj-AcdqCjfNqn_-Lw8A"

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Start Ignition Gateway
        run: |
          echo "Starting Ignition 8.3.2 via Docker Compose..."
          docker compose up -d
          
          echo "Waiting for Gateway to be ready at $IGNITION_HOST..."
          # The post_start hook in compose handles the restore and restart. 
          # We just need to wait for the final healthy state.
          timeout 300s bash -c "until curl -s -f $IGNITION_HOST/system/gwinfo; do echo 'Still waiting...'; sleep 10; done"
          echo "Ignition Gateway is up!"
          
      - name: Debug Gateway API
        run: |
          echo "Testing API connectivity..."
          curl -v -H "X-Ignition-API-Token: ${{ env.IGNITION_TOKEN }}" ${{ env.IGNITION_HOST }}/system/gwinfo
          curl -v -H "X-Ignition-API-Token: ${{ env.IGNITION_TOKEN }}" ${{ env.IGNITION_HOST }}/data/api/v1/projects
        continue-on-error: true

      - name: Run Acceptance Tests
        run: go test -v ./internal/provider/...
        env:
          TF_ACC: "1"
